name: Mirror Kits to mparticle-integrations (PoC)

on:
  workflow_dispatch:
  push:
    branches:
      - "**"
    paths:
      - "kits/**"
      - ".github/workflows/mirror-kits-poc.yml"

jobs:
  mirror-kits:
    runs-on: ubuntu-latest
    env:
      DEST_ORG: mparticle-integrations
    strategy:
      fail-fast: false
      matrix:
        kit:
          - name: braze-12
            local_path: kits/braze/braze-12
            dest_repo: mparticle-apple-integration-braze-12
    #          - name: braze-13
    #            local_path: kits/braze/braze-13
    #            dest_repo: mparticle-apple-integration-braze-13
    #          - name: braze-14
    #            local_path: kits/braze/braze-14
    #            dest_repo: mparticle-apple-integration-braze-14

    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history required for git subtree split
          ref: ${{ github.ref }}

      - name: Configure Git
        run: |
          git config user.name "mParticle Bot"
          git config user.email "developers@mparticle.com"

      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.SDK_RELEASE_GITHUB_APP_ID }}
          private-key: ${{ secrets.SDK_RELEASE_GITHUB_APP_PRIVATE_KEY }}
          owner: ${{ env.DEST_ORG }}
          repositories: ${{ matrix.kit.dest_repo }}

      - name: Verify kit directory exists
        run: |
          if [ ! -d "${{ matrix.kit.local_path }}" ]; then
            echo "âŒ Error: Kit directory ${{ matrix.kit.local_path }} does not exist"
            echo "This kit has not been imported yet. Please run git subtree add first."
            exit 1
          fi

          echo "âœ… Kit directory exists: ${{ matrix.kit.local_path }}"
          echo ""
          echo "Directory contents:"
          ls -la ${{ matrix.kit.local_path }}

      - name: Split kit directory into branch
        id: split
        run: |
          SPLIT_BRANCH="split/${{ matrix.kit.name }}-$(date +%s)"
          echo "split_branch=${SPLIT_BRANCH}" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Creating split branch: ${SPLIT_BRANCH}"
          echo "   from: ${{ matrix.kit.local_path }}"

          git subtree split --prefix ${{ matrix.kit.local_path }} -b ${SPLIT_BRANCH}

          echo ""
          echo "âœ… Split branch created successfully"
          echo ""
          echo "Recent commits in split branch:"
          git log ${SPLIT_BRANCH} --oneline | head -10

      - name: Push to destination repository
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          DEST_URL="https://x-access-token:${GITHUB_TOKEN}@github.com/${{ env.DEST_ORG }}/${{ matrix.kit.dest_repo }}.git"

          echo "ðŸš€ Pushing to destination repository"
          echo "   Repo: ${{ env.DEST_ORG }}/${{ matrix.kit.dest_repo }}"
          echo "   Branch: main"
          echo ""

          git remote add dest-${{ matrix.kit.name }} "${DEST_URL}"

          git push dest-${{ matrix.kit.name }} \
            ${{ steps.split.outputs.split_branch }}:main \
            --force

          echo ""
          echo "âœ… Successfully pushed to ${{ env.DEST_ORG }}/${{ matrix.kit.dest_repo }}"

      - name: Cleanup split branch
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up split branch"
          git branch -D ${{ steps.split.outputs.split_branch }} || true
          echo "âœ… Cleanup complete"

      - name: Summary
        if: success()
        run: |
          echo "## âœ… Mirror Complete: ${{ matrix.kit.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Source** | \`${{ matrix.kit.local_path }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Destination** | https://github.com/${{ env.DEST_ORG }}/${{ matrix.kit.dest_repo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`main\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Kit** | ${{ matrix.kit.name }} |" >> $GITHUB_STEP_SUMMARY
