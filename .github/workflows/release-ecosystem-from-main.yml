name: Release mParticle Ecosystem

on:
  push:
    # TODO: Remove ci/** after testing
    branches:
      - main
      - "ci/**"
    paths:
      - "VERSION"
      - ".github/workflows/release-ecosystem-from-main.yml"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run ‚Äî skip creating real releases/tags"
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - uses: actions/checkout@v6

      - name: Get ecosystem version
        id: version
        run: |
          VERSION=$(head -n 1 VERSION | tr -d '\r\n ')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "üìå Ecosystem version: $VERSION"

  release-core:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Extract release notes
        id: release-notes
        uses: ffurrer2/extract-release-notes@202313ec7461b6b9e401996714484690ab1ae105 # v3.0.0
        with:
          changelog_file: CHANGELOG.md

      - name: Dry run summary
        if: inputs.dry_run
        run: |
          echo "üèúÔ∏è DRY RUN ‚Äî would create core release:"
          echo "  Tag: ${{ needs.prepare.outputs.tag }}"
          echo "  Release notes:"
          echo "${{ steps.release-notes.outputs.release_notes }}"

      - name: Create GitHub release
        if: ${{ !inputs.dry_run }}
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        with:
          tag: ${{ needs.prepare.outputs.tag }}
          makeLatest: true
          body: |
            ## Release notes
            ${{ steps.release-notes.outputs.release_notes }}

  mirror-and-release-kits:
    needs: prepare
    runs-on: ubuntu-latest
    env:
      DEST_ORG: mparticle-integrations
    strategy:
      fail-fast: false
      matrix:
        kit:
          - name: braze-12
            local_path: kits/braze/braze-12
            dest_repo: mparticle-apple-integration-braze-12
    #      - name: braze-13
    #        local_path: kits/braze/braze-13
    #        dest_repo: mparticle-apple-integration-braze-13
    #      - name: braze-14
    #        local_path: kits/braze/braze-14
    #        dest_repo: mparticle-apple-integration-braze-14

    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "mParticle Bot"
          git config user.email "developers@mparticle.com"

      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.SDK_RELEASE_GITHUB_APP_ID }}
          private-key: ${{ secrets.SDK_RELEASE_GITHUB_APP_PRIVATE_KEY }}
          owner: ${{ env.DEST_ORG }}
          repositories: ${{ matrix.kit.dest_repo }}
          permission-contents: write

      - name: Extract kit release notes
        id: release-notes
        uses: ffurrer2/extract-release-notes@202313ec7461b6b9e401996714484690ab1ae105 # v3.0.0
        with:
          changelog_file: ${{ matrix.kit.local_path }}/CHANGELOG.md

      - name: Split kit and push to mirror
        id: mirror
        run: |
          SPLIT_BRANCH="split/${{ matrix.kit.name }}"

          git subtree split --prefix ${{ matrix.kit.local_path }} -b "${SPLIT_BRANCH}"

      - name: Checkout destination repo
        uses: actions/checkout@v6
        with:
          repository: ${{ env.DEST_ORG }}/${{ matrix.kit.dest_repo }}
          token: ${{ steps.generate-token.outputs.token }}
          path: dest

      - name: Push split to destination
        if: ${{ !inputs.dry_run }}
        id: push
        run: |
          git -C dest fetch "$GITHUB_WORKSPACE" "split/${{ matrix.kit.name }}:refs/heads/incoming"
          git -C dest reset --hard incoming
          git -C dest push origin main --force
          echo "sha=$(git -C dest rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Create GitHub release on mirror
        if: ${{ !inputs.dry_run }}
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        with:
          tag: ${{ needs.prepare.outputs.tag }}
          commit: ${{ steps.push.outputs.sha }}
          owner: ${{ env.DEST_ORG }}
          repo: ${{ matrix.kit.dest_repo }}
          token: ${{ steps.generate-token.outputs.token }}
          body: |
            ${{ steps.release-notes.outputs.release_notes }}

      - name: Dry run summary
        if: inputs.dry_run
        run: |
          echo "üèúÔ∏è DRY RUN ‚Äî would mirror and release kit:"
          echo "  Kit: ${{ matrix.kit.name }}"
          echo "  Dest: ${{ env.DEST_ORG }}/${{ matrix.kit.dest_repo }}"
          echo "  Tag: ${{ needs.prepare.outputs.tag }}"
          echo "  Split branch commits:"
          git log "split/${{ matrix.kit.name }}" --oneline -5
          echo "  Release notes:"
          echo "${{ steps.release-notes.outputs.release_notes }}"

      - name: Cleanup split branch
        if: always()
        run: git branch -D "split/${{ matrix.kit.name }}" || true
