name: Build Kits

on:
  workflow_call:
  workflow_dispatch:

jobs:
  load-matrix:
    name: Load kit matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6
        with:
          sparse-checkout: kits/matrix.json
          sparse-checkout-cone-mode: false
      - id: set
        run: echo "matrix=$(jq -c . kits/matrix.json)" >> "$GITHUB_OUTPUT"

  build-kits:
    name: Build ${{ matrix.kit.name }}
    needs: load-matrix
    runs-on: macOS-latest
    env:
      XCODE_VERSION: "26.2"
    strategy:
      fail-fast: false
      matrix:
        kit: ${{ fromJson(needs.load-matrix.outputs.matrix) }}

    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Resolve SPM dependencies
        run: |
          PROJECT="$(ls -d ${{ matrix.kit.local_path }}/*.xcodeproj | head -1)"
          IOS_SCHEME="${{ matrix.kit.ios_scheme }}"
          xcodebuild -resolvePackageDependencies -project "$PROJECT" \
            -scheme "$IOS_SCHEME" -derivedDataPath DerivedData

      - name: Build kit (iOS)
        run: |
          PROJECT="$(ls -d ${{ matrix.kit.local_path }}/*.xcodeproj | head -1)"
          IOS_SCHEME="${{ matrix.kit.ios_scheme }}"

          xcodebuild build -project "$PROJECT" -scheme "$IOS_SCHEME" \
            -destination "generic/platform=iOS" \
            -derivedDataPath DerivedData \
            CODE_SIGN_IDENTITY= CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

          xcodebuild build -project "$PROJECT" -scheme "$IOS_SCHEME" \
            -destination "generic/platform=iOS Simulator" \
            -derivedDataPath DerivedData \
            CODE_SIGN_IDENTITY= CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

      - name: Build kit (tvOS)
        if: ${{ matrix.kit.tvos_scheme != '' }}
        run: |
          PROJECT="$(ls -d ${{ matrix.kit.local_path }}/*.xcodeproj | head -1)"
          TVOS_SCHEME="${{ matrix.kit.tvos_scheme }}"

          xcodebuild build -project "$PROJECT" -scheme "$TVOS_SCHEME" \
            -destination "generic/platform=tvOS" \
            -derivedDataPath DerivedData \
            CODE_SIGN_IDENTITY= CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

          xcodebuild build -project "$PROJECT" -scheme "$TVOS_SCHEME" \
            -destination "generic/platform=tvOS Simulator" \
            -derivedDataPath DerivedData \
            CODE_SIGN_IDENTITY= CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

      - name: Build SPM-Swift-Example
        run: |
          PROJECT="$(ls -d ${{ matrix.kit.local_path }}/Example/SPM-Swift-Example/*.xcodeproj | head -1)"
          xcodebuild build -project "$PROJECT" -scheme SPM-Swift-Example \
            -destination "generic/platform=iOS Simulator" \
            -derivedDataPath DerivedData-Example \
            CODE_SIGN_IDENTITY= CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

      - name: Build SPM-Objc-Example
        run: |
          PROJECT="$(ls -d ${{ matrix.kit.local_path }}/Example/SPM-Objc-Example/*.xcodeproj | head -1)"
          xcodebuild build -project "$PROJECT" -scheme SPM-Objc-Example \
            -destination "generic/platform=iOS Simulator" \
            -derivedDataPath DerivedData-Example \
            CODE_SIGN_IDENTITY= CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
