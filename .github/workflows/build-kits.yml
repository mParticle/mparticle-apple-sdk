name: Build Kits

on:
  workflow_call:
  workflow_dispatch:

jobs:
  build-kits:
    name: Build ${{ matrix.kit.name }}
    runs-on: macOS-latest
    env:
      XCODE_VERSION: "16.4"
    strategy:
      fail-fast: false
      matrix:
        kit:
          - name: braze-12
            local_path: kits/braze/braze-12
            ios_scheme: mParticle-Braze
            tvos_scheme: mParticle-Braze-tvOS
            module: mParticle_Braze
          - name: braze-13
            local_path: kits/braze/braze-13
            ios_scheme: mParticle-Braze
            tvos_scheme: mParticle-Braze-tvOS
            module: mParticle_Braze

    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Build kit (iOS)
        run: |
          PROJECT="$(ls -d ${{ matrix.kit.local_path }}/*.xcodeproj | head -1)"
          IOS_SCHEME="${{ matrix.kit.ios_scheme }}"

          xcodebuild build -project "$PROJECT" -scheme "$IOS_SCHEME" \
            -destination "generic/platform=iOS" \
            CODE_SIGN_IDENTITY= CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

          xcodebuild build -project "$PROJECT" -scheme "$IOS_SCHEME" \
            -destination "generic/platform=iOS Simulator" \
            CODE_SIGN_IDENTITY= CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

      - name: Build kit (tvOS)
        if: ${{ matrix.kit.tvos_scheme != '' }}
        run: |
          PROJECT="$(ls -d ${{ matrix.kit.local_path }}/*.xcodeproj | head -1)"
          TVOS_SCHEME="${{ matrix.kit.tvos_scheme }}"

          xcodebuild build -project "$PROJECT" -scheme "$TVOS_SCHEME" \
            -destination "generic/platform=tvOS" \
            CODE_SIGN_IDENTITY= CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

          xcodebuild build -project "$PROJECT" -scheme "$TVOS_SCHEME" \
            -destination "generic/platform=tvOS Simulator" \
            CODE_SIGN_IDENTITY= CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

      - name: Run tests (if present)
        run: |
          PROJECT="$(ls -d ${{ matrix.kit.local_path }}/*.xcodeproj | head -1)"
          IOS_SCHEME="${{ matrix.kit.ios_scheme }}"
          KIT_PATH="${{ matrix.kit.local_path }}"

          # Check for a test scheme or a non-empty Tests/ directory
          HAS_TEST_SCHEME=$(xcodebuild -project "$PROJECT" -list 2>/dev/null \
            | grep -E "^\s+${IOS_SCHEME}Tests$" | wc -l | tr -d ' ')

          HAS_TEST_DIR=0
          if [ -d "${KIT_PATH}/Tests" ] && [ -n "$(ls -A "${KIT_PATH}/Tests" 2>/dev/null)" ]; then
            HAS_TEST_DIR=1
          fi

          if [ "$HAS_TEST_SCHEME" -gt 0 ]; then
            TEST_SCHEME="${IOS_SCHEME}Tests"
            xcodebuild test -project "$PROJECT" -scheme "$TEST_SCHEME" \
              -destination "platform=iOS Simulator,name=iPhone 16,OS=latest" \
              CODE_SIGN_IDENTITY= CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
          elif [ "$HAS_TEST_DIR" -eq 1 ]; then
            xcodebuild test -project "$PROJECT" -scheme "$IOS_SCHEME" \
              -destination "platform=iOS Simulator,name=iPhone 16,OS=latest" \
              CODE_SIGN_IDENTITY= CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
          else
            echo "No tests found for ${{ matrix.kit.name }} — skipping."
          fi

      - name: Build SPM-Swift-Example
        run: |
          EXAMPLE_PATH="${{ matrix.kit.local_path }}/Example/SPM-Swift-Example"
          if [ ! -d "$EXAMPLE_PATH" ]; then
            echo "SPM-Swift-Example not found for ${{ matrix.kit.name }} — skipping."
            exit 0
          fi
          PROJECT="$(ls -d ${EXAMPLE_PATH}/*.xcodeproj 2>/dev/null | head -1)"
          if [ -z "$PROJECT" ]; then
            echo "No xcodeproj in SPM-Swift-Example — skipping."
            exit 0
          fi
          xcodebuild build -project "$PROJECT" \
            -destination "generic/platform=iOS Simulator" \
            CODE_SIGN_IDENTITY= CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

      - name: Build SPM-Objc-Example
        run: |
          EXAMPLE_PATH="${{ matrix.kit.local_path }}/Example/SPM-Objc-Example"
          if [ ! -d "$EXAMPLE_PATH" ]; then
            echo "SPM-Objc-Example not found for ${{ matrix.kit.name }} — skipping."
            exit 0
          fi
          PROJECT="$(ls -d ${EXAMPLE_PATH}/*.xcodeproj 2>/dev/null | head -1)"
          if [ -z "$PROJECT" ]; then
            echo "No xcodeproj in SPM-Objc-Example — skipping."
            exit 0
          fi
          xcodebuild build -project "$PROJECT" \
            -destination "generic/platform=iOS Simulator" \
            CODE_SIGN_IDENTITY= CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
